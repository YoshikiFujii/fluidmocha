<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Attendance System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/liquid.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Remxing Icons for nice icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="images/mocha-logo.png">
</head>

<body class="auth-loading">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <img src="images/mocha-logo.png" alt="Mocha Logo" style="max-width: 120px; height: auto;">
                </div>
                <div class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="ri-menu-fold-line"></i>
                </div>
            </div>
            <div class="nav-item active" data-tab="events" onclick="switchTab('events')">
                <i class="ri-calendar-event-line"></i> <span class="nav-text">イベント</span>
            </div>
            <div class="nav-item" data-tab="rosters" onclick="switchTab('rosters')">
                <i class="ri-group-line"></i> <span class="nav-text">名簿管理</span>
            </div>
            <div class="nav-item" data-tab="users" onclick="switchTab('users')">
                <i class="ri-user-settings-line"></i> <span class="nav-text">ユーザ管理</span>
            </div>
            <div style="margin-top: auto;">
                <div style="padding: 0 1.5rem 0.5rem; font-size: 0.8rem; color: #666; font-weight: 500;">管理者</div>
                <div class="nav-item" style="color: #ef4444; margin-top: auto;"
                    onclick="window.location.href='api/logout.php'">
                    <i class="ri-logout-box-line"></i> <span class="nav-text">ログアウト</span>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">

            <!-- Events Tab -->
            <div id="tab-events">
                <div class="header-controls">
                    <h2>イベント一覧</h2>
                    <button class="btn-primary" style="width: auto;" onclick="openModal('eventModal')">
                        <i class="ri-add-line"></i> イベント作成
                    </button>
                </div>
                <!-- Event List -->
                <div id="eventList" class="list-container">
                    <!-- Loaded via JS -->
                </div>
            </div>

            <!-- Rosters Tab -->
            <div id="tab-rosters" class="hidden">
                <div class="header-controls">
                    <h2>名簿一覧</h2>
                    <button class="btn-primary" style="width: auto;" onclick="openModal('rosterModal')">
                        <i class="ri-file-excel-2-line"></i> 名簿インポート
                    </button>
                </div>
                <!-- Roster List -->
                <div id="rosterList" class="list-container">
                    <!-- Loaded via JS -->
                </div>
            </div>

            <!-- Users Tab -->
            <div id="tab-users" class="hidden">
                <div class="header-controls">
                    <h2>ユーザ管理</h2>
                    <button class="btn-primary" style="width: auto;" onclick="openUserModal()">
                        <i class="ri-user-add-line"></i> ユーザ作成
                    </button>
                </div>
                <div id="userList" class="list-container">
                    <!-- Loaded via JS -->
                </div>
            </div>

            <!-- View Roster Details (Hidden by default) -->
            <div id="view-roster-details" class="hidden">
                <div class="header-controls">
                    <button class="btn-secondary" onclick="backToRosters()">
                        <i class="ri-arrow-left-line"></i> 戻る
                    </button>
                    <h2 id="detailRosterName">名簿詳細</h2>
                    <button class="btn-secondary" onclick="openColumnSettings('roster')">
                        <i class="ri-settings-3-line"></i> 表示設定
                    </button>
                </div>
                <div class="glass-card" style="padding: 0;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: rgba(0,0,0,0.05); border-bottom: 1px solid #ddd;">
                            <tr>
                                <th class="col-room" style="padding: 1rem; text-align: left;">部屋番号</th>
                                <th class="col-name" style="padding: 1rem; text-align: left;">氏名</th>
                                <th class="col-floor" style="padding: 1rem; text-align: left;">階</th>
                                <th class="col-gender" style="padding: 1rem; text-align: left;">性別</th>
                                <th class="col-category" style="padding: 1rem; text-align: left;">区分</th>
                                <th class="col-kana" style="padding: 1rem; text-align: left;">かな</th>
                                <th class="col-hometown" style="padding: 1rem; text-align: left;">出身</th>
                                <th class="col-student_num" style="padding: 1rem; text-align: left;">学籍番号</th>
                                <th class="col-department" style="padding: 1rem; text-align: left;">学科</th>
                            </tr>
                        </thead>
                        <tbody id="rosterStudentList">
                            <!-- Students via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Event Details View (Hidden by default) -->
            <div id="view-event-details" class="hidden">
                <div class="header-controls">
                    <button class="btn-secondary" onclick="backToEvents()">
                        <i class="ri-arrow-left-line"></i> 戻る
                    </button>
                    <h2 id="detailEventName">イベント名</h2>
                    <button class="btn-secondary" onclick="openColumnSettings('event')">
                        <i class="ri-settings-3-line"></i> 表示設定
                    </button>
                </div>
                <!-- Search Box -->
                <div class="glass-card" style="padding: 1.5rem; margin-bottom: 2rem;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <i class="ri-search-line" style="font-size: 1.5rem; color: #666;"></i>
                        <input type="text" id="studentSearch" placeholder="名前で検索..."
                            style="width: 100%; font-size: 1.2rem; padding: 0.5rem; border: none; background: transparent; outline: none;">
                    </div>
                    <div id="statusFilters" style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                        <!-- Checkboxes loaded via JS -->
                    </div>
                </div>

                <!-- Stats Dashboard (Hidden by default, shown via JS) -->
                <div id="statsDashboard" class="stats-grid hidden" style="margin-bottom: 2rem;">
                    <!-- Injected via JS -->
                </div>

                <div class="glass-card" style="padding: 0;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: rgba(0,0,0,0.05); border-bottom: 1px solid #ddd;">
                            <tr>
                                <th class="col-status" style="padding: 1rem; text-align: left;">状態</th>
                                <th class="col-name" style="padding: 1rem; text-align: left;">氏名</th>
                                <th class="col-kana" style="padding: 1rem; text-align: left;">かな</th>
                                <th class="col-gender" style="padding: 1rem; text-align: left;">性別</th>
                                <th class="col-room" style="padding: 1rem; text-align: left;">部屋番号</th>
                                <th class="col-floor" style="padding: 1rem; text-align: left;">階</th>
                                <th class="col-category" style="padding: 1rem; text-align: left;">区分</th>
                                <th class="col-hometown" style="padding: 1rem; text-align: left;">出身</th>
                                <th class="col-student_num" style="padding: 1rem; text-align: left;">学籍番号</th>
                                <th class="col-department" style="padding: 1rem; text-align: left;">学科</th>
                                <th class="col-note" style="padding: 1rem; text-align: left;">備考</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceList">
                            <!-- Rows loaded via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- Create Event Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content glass-card">
            <h3>イベント作成</h3>
            <form id="createEventForm">
                <div class="input-group">
                    <label>イベント名</label>
                    <input type="text" id="eventName" required>
                </div>
                <div class="input-group">
                    <label>名簿選択</label>
                    <select id="eventRosterSelect"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #d1d5db;" required>
                        <!-- Options loaded via JS -->
                    </select>
                </div>
                <div class="input-group">
                    <label>プリセット</label>
                    <select id="eventPresetSelect"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #d1d5db;">
                        <option value="default">デフォルト (出席/欠席)</option>
                        <option value="entry_management">入寮運営</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn-secondary" onclick="closeModal('eventModal')">キャンセル</button>
                    <button type="submit" class="btn-primary">作成</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="editEventModal" class="modal">
        <div class="modal-content glass-card">
            <h3>イベント編集</h3>
            <form id="editEventForm">
                <input type="hidden" id="editEventId">
                <div class="input-group">
                    <label>イベント名</label>
                    <input type="text" id="editEventName" required>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn-secondary" onclick="closeModal('editEventModal')">キャンセル</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    </form>
    </div>
    </div>

    <!-- Column Settings Modal -->
    <div id="columnSettingsModal" class="modal">
        <div class="modal-content glass-card">
            <h3>表示カラム設定</h3>
            <div id="columnSettingsContainer"
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <!-- Checkboxes loaded via JS -->
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn-secondary" onclick="closeModal('columnSettingsModal')">閉じる</button>
                <button type="button" class="btn-primary" onclick="saveColumnSettings()">保存</button>
            </div>
        </div>
    </div>

    <!-- Import Roster Modal -->
    <div id="rosterModal" class="modal">
        <div class="modal-content glass-card">
            <h3>Import Roster (Excel)</h3>
            <form id="importRosterForm">
                <input type="hidden" id="editRosterId">

                <div class="input-group">
                    <label>Roster Name</label>
                    <input type="text" id="rosterName" required>
                </div>

                <div id="fileUploadGroup" class="input-group">
                    <label>Excel File</label>
                    <input type="file" id="rosterFile" accept=".xlsx, .xls">
                </div>

                <h4>Column Mapping (Column Number, e.g., 1 for A)</h4>
                <div class="settings-grid">
                    <div class="input-group">
                        <label>Room</label>
                        <input type="number" id="col_room" placeholder="1">
                    </div>
                    <div class="input-group">
                        <label>Name</label>
                        <input type="number" id="col_name" placeholder="2">
                    </div>
                    <div class="input-group">
                        <label>Floor</label>
                        <input type="number" id="col_floor">
                    </div>
                    <div class="input-group">
                        <label>Gender</label>
                        <input type="number" id="col_gender">
                    </div>
                    <div class="input-group">
                        <label>Category</label>
                        <input type="number" id="col_category">
                    </div>
                    <div class="input-group">
                        <label>Kana</label>
                        <input type="number" id="col_kana">
                    </div>
                    <div class="input-group">
                        <label>Hometown</label>
                        <input type="number" id="col_hometown">
                    </div>
                    <div class="input-group">
                        <label>Student Num</label>
                        <input type="number" id="col_student_num">
                    </div>
                    <div class="input-group">
                        <label>Department</label>
                        <input type="number" id="col_department">
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn-secondary" onclick="closeModal('rosterModal')">Cancel</button>
                    <button type="submit" class="btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content glass-card">
            <h3>ユーザ編集</h3>
            <form id="userForm">
                <input type="hidden" id="editUserId">
                <div class="input-group">
                    <label>ユーザー名</label>
                    <input type="text" id="username" required>
                </div>
                <div class="input-group">
                    <label>パスワード (変更する場合のみ入力)</label>
                    <input type="password" id="password" placeholder="******">
                </div>
                <div class="input-group">
                    <label>Redirect Page</label>
                    <select id="userRedirect" onchange="toggleFloorOptions()"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #d1d5db;">
                        <option value="dashboard.html">Dashboard (Admin)</option>
                        <option value="entrance.html">Entrance</option>
                        <option value="reception.html">Reception (All)</option>
                        <option value="reception-souhou.html">Reception (Souhou/Male)</option>
                        <option value="reception-tsubaki.html">Reception (Tsubaki/Female)</option>
                        <option value="floor.html">Floor (Guiding/Guided)</option>
                    </select>
                </div>

                <!-- Floor/Gender Settings (Hidden unless Floor is selected) -->
                <div id="floorSettings"
                    style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.02); border-radius: 8px;">
                    <div class="input-group">
                        <label>Dormitory / Gender</label>
                        <select id="assignedGender" onchange="updateFloorOptions()"
                            style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #d1d5db;">
                            <option value="">Select...</option>
                            <option value="Male">Souhou (Male)</option>
                            <option value="Female">Tsubaki (Female)</option>
                        </select>
                    </div>
                    <div class="input-group" style="margin-top: 0.5rem;">
                        <label>Assigned Floor</label>
                        <select id="assignedFloor"
                            style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #d1d5db;">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn-secondary" onclick="closeModal('userModal')">キャンセル</button>
                    <button type="button" class="btn-primary" onclick="saveUser()">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        // Dashboard Auto-Refresh Logic
        let currentStudents = [];
        let pollingInterval = null;
        let currentEventId = null;
        let currentPreset = 'default';

        // Override showEventDetails to add polling
        const originalShowEventDetails = showEventDetails;
        showEventDetails = async function (eventId) {
            currentEventId = eventId;
            // ...
            // Call original UI logic or re-implement?
            // Re-implementing is safer to ensure we have control over the data flow
            document.getElementById('tab-events').classList.add('hidden');
            document.getElementById('tab-rosters').classList.add('hidden');
            document.getElementById('view-event-details').classList.remove('hidden');

            const res = await fetch(`api/event.php?id=${eventId}`);
            const data = await res.json();
            const evt = data.event;
            const students = data.students;

            const preset = evt.preset || 'default';
            const presetLabel = PRESET_NAMES[preset] || PRESET_NAMES['default'];
            document.getElementById('detailEventName').innerText = `${evt.name} (${presetLabel})`;

            currentPreset = preset; // Update global

            // Stats Dashboard logic
            const statsContainer = document.getElementById('statsDashboard');
            if (statsContainer) {
                if (preset === 'entry_management') {
                    statsContainer.classList.remove('hidden');
                    if (typeof renderStats === 'function') renderStats(students);
                } else {
                    statsContainer.classList.add('hidden');
                }
            }



            // Render Status Filters
            renderStatusFilters();

            // Render list
            currentStudents = students;
            // Apply filter/sort immediately
            const term = document.getElementById('studentSearch') ? document.getElementById('studentSearch').value : '';
            filterStudents(term);

            // Start Polling
            startPolling(eventId);
        };

        // Override backToEvents to stop polling
        const originalBackToEvents = backToEvents;
        backToEvents = function () {
            stopPolling();
            document.getElementById('view-event-details').classList.add('hidden');
            if (document.getElementById('statsDashboard')) {
                document.getElementById('statsDashboard').classList.add('hidden');
            }
            document.getElementById('tab-events').classList.remove('hidden');
            loadEvents(); // Reload list
        };

        // Polling Functions
        function startPolling(eventId) {
            stopPolling();
            pollingInterval = setInterval(() => checkUpdates(eventId), 5000);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        async function checkUpdates(eventId) {
            try {
                const res = await fetch(`api/event.php?id=${eventId}`);
                const data = await res.json();
                const newStudents = data.students;
                // Update preset just in case it changed?
                const preset = data.event.preset || 'default';
                currentPreset = preset;

                const currentStatuses = currentStudents.map(s => s.status);
                const newStatuses = newStudents.map(s => s.status);

                if (JSON.stringify(currentStatuses) !== JSON.stringify(newStatuses)) {
                    // Update needed
                    currentStudents = newStudents;

                    const term = document.getElementById('studentSearch') ? document.getElementById('studentSearch').value : '';
                    filterStudents(term);

                    // Update Stats
                    if (typeof renderStats === 'function' && preset === 'entry_management') {
                        renderStats(newStudents);
                    }
                }
            } catch (e) {
                console.error("Polling error", e);
            }
        }

        function renderAttendanceList(students, preset) {
            const tbody = document.getElementById('attendanceList');
            tbody.innerHTML = '';

            const statusMap = PRESET_STATUSES[preset] || PRESET_STATUSES['default'];
            const defaultStatus = preset === 'entry_management' ? 'not_arrived' : 'absent';

            students.forEach(student => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #eee';

                const currentStatus = student.status || defaultStatus;

                let options = '';
                for (let k in statusMap) {
                    const selected = currentStatus === k ? 'selected' : '';
                    options += `<option value="${k}" ${selected}>${statusMap[k]}</option>`;
                }

                let bg = getStatusColor(currentStatus);
                if (preset === 'entry_management') bg = PRESET_COLORS[currentStatus] || bg;

                // We need to use updateAttendance from app.js which is global
                tr.innerHTML = `
                    <td class="col-status" style="padding: 1rem;">
                        <select onchange="updateAttendance(${currentEventId || 'currentEventId'}, '${student.internal_id}', this.value, null, '${preset}')" 
                                style="padding: 0.5rem; border-radius: 6px; border: 1px solid #ddd; background: ${bg}">
                            ${options}
                        </select>
                    </td>
                    <td class="col-name" style="padding: 1rem;">${student.name}</td>
                    <td class="col-kana" style="padding: 1rem;">${student.kana || ''}</td>
                    <td class="col-gender" style="padding: 1rem;">${student.gender || ''}</td>
                    <td class="col-room" style="padding: 1rem;">${student.room || '-'}</td>
                    <td class="col-floor" style="padding: 1rem;">${student.floor || ''}</td>
                    <td class="col-category" style="padding: 1rem;">${student.category || ''}</td>
                    <td class="col-hometown" style="padding: 1rem;">${student.hometown || ''}</td>
                    <td class="col-student_num" style="padding: 1rem;">${student.student_num || ''}</td>
                    <td class="col-department" style="padding: 1rem;">${student.department || ''}</td>
                    <td class="col-note" style="padding: 1rem;">
                        <input type="text" placeholder="Note..." value="${student.note || ''}" 
                               onblur="updateAttendance(${currentEventId || 'currentEventId'}, '${student.internal_id}', null, this.value, '${preset}')"
                               style="padding: 0.5rem; border-radius: 6px; border: 1px solid #ddd; width: 100%;">
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if (typeof applyColumnVisibility === 'function') {
                applyColumnVisibility('event');
            }
        }

        // We need to ensure logic from app.js like renderAttendanceList is available. 
        // It is global in app.js.

        // --- User Management Logic ---
        async function loadUsers() {
            const res = await fetch('api/users.php');
            const data = await res.json();
            const list = document.getElementById('userList');
            list.innerHTML = '';

            data.users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>${user.username}</h3>
                    <span style="font-size: 0.8rem; color: #666;">${user.redirect_page || 'dashboard.html'}</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                    ${user.assigned_gender ? `Gender: ${user.assigned_gender}, ` : ''}
                    ${user.assigned_floor ? `Floor: ${user.assigned_floor}` : ''}
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                     <button class="btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" 
                        onclick='openUserModal(${JSON.stringify(user)})'>Edit</button>
                     <button class="btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; color: #ef4444; border-color: #fee2e2; background: #fef2f2;" onclick="deleteUser(${user.id})">Delete</button>
                </div>
            `;
                list.appendChild(div);
            });
        }

        function openUserModal(user = null) {
            document.getElementById('userModal').classList.add('active');
            if (user) {
                document.getElementById('editUserId').value = user.id;
                document.getElementById('username').value = user.username;
                document.getElementById('password').value = ''; // Don't show hash
                document.getElementById('userRedirect').value = user.redirect_page || 'dashboard.html';

                // Set Floor Settings
                document.getElementById('assignedGender').value = user.assigned_gender || '';
                updateFloorOptions(); // triggers populating floors
                document.getElementById('assignedFloor').value = user.assigned_floor || '';

                toggleFloorOptions();
            } else {
                document.getElementById('userForm').reset();
                document.getElementById('editUserId').value = '';
                toggleFloorOptions();
            }
        }

        async function saveUser() {
            const id = document.getElementById('editUserId').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const redirect_page = document.getElementById('userRedirect').value;

            // Collect new fields
            const assigned_gender = document.getElementById('assignedGender').value;
            const assigned_floor = document.getElementById('assignedFloor').value;

            const body = { username, redirect_page };
            if (password) body.password = password;
            if (id) body.id = id;

            // Add new fields if relevant (or always send null if empty)
            body.assigned_gender = assigned_gender || null;
            body.assigned_floor = assigned_floor || null;

            const method = id ? 'PUT' : 'POST';
            try {
                const res = await fetch('api/users.php', {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                if (data.status === 'success') {
                    closeModal('userModal');
                    loadUsers();
                } else {
                    alert(data.message);
                }
            } catch (e) {
                console.error(e);
                alert('An error occurred while saving the user.');
            }
        }

        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            try {
                const res = await fetch(`api/users.php?id=${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.status === 'success') {
                    loadUsers();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (e) {
                console.error(e);
            }
        }

        function toggleFloorOptions() {
            const redirect = document.getElementById('userRedirect').value;
            const settings = document.getElementById('floorSettings');
            if (redirect === 'floor.html') {
                settings.style.display = 'block';
            } else {
                settings.style.display = 'none';
            }
        }

        function updateFloorOptions() {
            const gender = document.getElementById('assignedGender').value;
            const floorSelect = document.getElementById('assignedFloor');
            const currentFloor = floorSelect.value;
            floorSelect.innerHTML = ''; // Clear

            let start = 2;
            let end = 8; // Default Souhou max

            if (gender === 'Female') {
                end = 6; // Tsubaki max
            }

            // Always add empty option
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.text = 'Select Floor...';
            floorSelect.appendChild(defaultOpt);

            for (let i = start; i <= end; i++) {
                const opt = document.createElement('option');
                opt.value = i + 'F'; // Store as "2F"
                opt.text = i + 'F';
                if (opt.value === currentFloor) opt.selected = true;
                floorSelect.appendChild(opt);
            }
        }




        // --- Search Logic ---
        const searchInput = document.getElementById('studentSearch');
        if (searchInput) {
            const handler = (e) => filterStudents(e.target.value);
            searchInput.addEventListener('input', handler);
            searchInput.addEventListener('search', handler);
        }

        function toKatakana(str) {
            return str.replace(/[\u3041-\u3096]/g, function (match) {
                var chr = match.charCodeAt(0) + 0x60;
                return String.fromCharCode(chr);
            });
        }

        function renderStatusFilters() {
            const container = document.getElementById('statusFilters');
            if (!container) return;
            container.innerHTML = '';

            // If PRESET_STATUSES is undefined (maybe app.js not loaded?), handle gracefully
            if (typeof PRESET_STATUSES === 'undefined') return;

            const statusMap = PRESET_STATUSES[currentPreset] || PRESET_STATUSES['default'];

            Object.keys(statusMap).forEach(key => {
                let bg = getStatusColor(key);
                if (currentPreset === 'entry_management') bg = PRESET_COLORS[key] || bg;

                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '0.5rem';
                label.style.cursor = 'pointer';
                label.style.padding = '0.25rem 0.75rem';
                label.style.borderRadius = '20px';
                label.style.background = 'rgba(255, 255, 255, 0.5)';
                label.style.border = '1px solid #ddd';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = key;
                checkbox.checked = true; // Default all checked
                checkbox.onchange = () => filterStudents(document.getElementById('studentSearch').value);

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(statusMap[key]));
                container.appendChild(label);
            });
        }

        function filterStudents(term) {
            let checkedStatuses = null;
            const container = document.getElementById('statusFilters');
            if (container) {
                checkedStatuses = Array.from(container.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
            }

            const defaultStatus = currentPreset === 'entry_management' ? 'not_arrived' : 'absent';

            const termActive = !!term;
            const normalizedTerm = term ? toKatakana(term).normalize('NFKC').toLowerCase() : '';
            const rawTerm = term ? term.toLowerCase() : '';

            const filtered = currentStudents.filter(s => {
                const status = s.status || defaultStatus;

                // Status Filter
                if (checkedStatuses && !checkedStatuses.includes(status)) return false;

                if (!termActive) return true;

                const name = (s.name || '').toLowerCase();
                const kanaRaw = (s.kana || '');
                const kanaNorm = kanaRaw.normalize('NFKC');
                const room = (s.room || '').toString().toLowerCase(); // Room Search

                return name.includes(rawTerm) || kanaNorm.includes(normalizedTerm) || room.includes(rawTerm);
            });

            // Sort by updated_at DESC if no search term
            if (!termActive) {
                filtered.sort((a, b) => {
                    const timeA = a.updated_at ? new Date(a.updated_at.replace(/-/g, '/')).getTime() : 0;
                    const timeB = b.updated_at ? new Date(b.updated_at.replace(/-/g, '/')).getTime() : 0;
                    return timeB - timeA;
                });
            }

            renderAttendanceList(filtered, currentPreset);
        }
    </script>
    <script src="js/background.js"></script>
    <script src="js/auth.js"></script> <!-- Auth Check -->
</body>

```